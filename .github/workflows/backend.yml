name: Deploy Backend to EC2
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::139228973770:role/GitHubActions-SSM-Role
          aws-region: eu-west-1

      - name: Deploy Backend via SSM
        run: |
          echo "ðŸš€ Starting SSM deployment..."
          
          aws ssm send-command \
            --instance-ids i-07c0cb7897a9427f4 \
            --document-name AWS-RunShellScript \
            --parameters commands='cd /home/ubuntu/CloudMediaVault/backend; git pull origin main; docker compose down || true; docker compose build --no-cache; docker compose up -d; docker ps' \
            --comment "GitHub Actions deploy #${{ github.run_number }}" \
            --region eu-west-1 \
            --query 'Command.CommandId' \
            --output text

          echo "âœ… Deployment triggered! Check AWS Console â†’ Systems Manager â†’ Run Command"
